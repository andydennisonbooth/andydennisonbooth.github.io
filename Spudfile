require 'net/http'
require_relative 'env'

publish do |message|
  invoke :clean
  invoke :build
  invoke :git, message
  invoke :purge
end

git do |message|
  sh 'git add -A'
  sh "git commit -m '#{message}'"
  sh 'git push'
end

serve do
  sh 'parcel src/index.pug'
end

build 'src/**' => ['index.html', 'dist/**'] do
  sh 'parcel build src/index.pug --public-url /dist'
  sh 'mv dist/index.html .'
end

purge do
  uri = URI("https://api.cloudflare.com/client/v4/zones/#{CONFIG.cloudflare_zone_identifier}/purge_cache")
  res = Net::HTTP.post(uri, { purge_everything: true }.to_json,
    'Authorization' => "Bearer #{CONFIG.cloudflare_api_token}",
    'Content-Type' => 'application/json',
  )

  puts "failed to purge cache: #{res.body}" unless res.code == '200'
end

clean do
  sh? 'rm -rf index.html .cache dist'
end

upgrade do
  sh 'gem install spud'
end
